{
  "description": "Test structure must match story graph exactly: file names match sub-epics (test_<sub_epic_name>.py), class names match stories exactly (Test<ExactStoryName>), method names match scenarios exactly (test_<scenario_name_snake_case>). Test classes appear in same order as stories in story map. Use pytest orchestrator pattern with helper functions/fixtures. Keep tests under 20 lines, helpers under 20 lines, classes under 300 lines.",
  "scanner": "agile_bot.bots.base_bot.src.scanners.class_based_organization_scanner.ClassBasedOrganizationScanner",
  "rationale": [
    "Test files organized by sub-epic keep related stories together",
    "One file per sub-epic prevents excessive file proliferation",
    "Test class names matching story names create clear traceability",
    "Test methods named after scenarios provide 1-to-1 traceability with story scenarios",
    "Easy to find tests: know sub-epic → find file, know story → find class, know scenario → find method",
    "Test structure mirrors story map hierarchy for consistency",
    "Developers can navigate from story map to tests intuitively",
    "Class-based organization groups related scenarios by story",
    "Orchestrator pattern keeps test methods readable and focused on flow, not implementation details",
    "Helper functions extract complex setup, keeping tests under 20 lines and readable",
    "File structure mirrors story map hierarchy: sub-epic → file, story → class, scenario → method"
  ],
  "examples": [
    {
      "do": {
        "description": "File matches sub-epic, class matches story exactly, methods match scenario names exactly",
        "content": [
          "# File: test_generate_bot_server_and_tools.py",
          "# Sub-epic: Generate Bot Server And Tools",
          "# Contains all stories for this sub-epic",
          "",
          "\"\"\"",
          "Generate Bot Server And Tools Tests",
          "",
          "Tests for all stories in the 'Generate Bot Server And Tools' sub-epic:",
          "- Generate Bot Tools",
          "- Generate Behavior Tools",
          "- Generate MCP Bot Server",
          "\"\"\"",
          "import pytest",
          "from pathlib import Path",
          "import json",
          "",
          "# ============================================================================",
          "# HELPER FUNCTIONS - Reusable operations (under 20 lines each)",
          "# ============================================================================",
          "",
          "def create_bot_config(workspace: Path, bot_name: str) -> Path:",
          "    \"\"\"Helper: Create bot configuration file.\"\"\"",
          "    config_path = workspace / 'bots' / bot_name / 'config.json'",
          "    config_path.parent.mkdir(parents=True, exist_ok=True)",
          "    config_path.write_text(json.dumps({'name': bot_name}))",
          "    return config_path",
          "",
          "# ============================================================================",
          "# FIXTURES",
          "# ============================================================================",
          "",
          "@pytest.fixture",
          "def workspace_root(tmp_path):",
          "    \"\"\"Fixture: Temporary workspace directory.\"\"\"",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    return workspace",
          "",
          "# ============================================================================",
          "# STORY: Generate Bot Tools",
          "# ============================================================================",
          "",
          "class TestGenerateBotTools:",
          "    \"\"\"Story: Generate Bot Tools - Tests bot tool generation.\"\"\"",
          "    ",
          "    def test_generator_creates_bot_tool_for_test_bot(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Generator creates bot tool for test_bot",
          "        GIVEN: Bot configuration exists",
          "        WHEN: Generator processes Bot Config",
          "        THEN: Generator creates bot tool instance",
          "        \"\"\"",
          "        # Given: Bot config exists",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Call REAL Generator API",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(bot_name='test_bot', config_path=bot_config, workspace_root=workspace_root)",
          "        tool = generator.generate_bot_tool()",
          "        ",
          "        # Then: Tool created",
          "        assert tool.name == 'test_bot_bot'",
          "",
          "    def test_generator_creates_tool_with_correct_parameters(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Generator creates tool with correct parameters",
          "        GIVEN: Bot configuration exists",
          "        WHEN: Generator processes Bot Config",
          "        THEN: Tool has correct behavior and action parameters",
          "        \"\"\"",
          "        # Given: Bot config exists",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Generate tool",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(bot_name='test_bot', config_path=bot_config, workspace_root=workspace_root)",
          "        tool = generator.generate_bot_tool()",
          "        ",
          "        # Then: Tool has correct parameters",
          "        assert 'bot_name' in tool.parameters",
          "        assert tool.parameters['bot_name'] == 'test_bot'",
          "",
          "# ============================================================================",
          "# STORY: Generate Behavior Tools",
          "# ============================================================================",
          "",
          "class TestGenerateBehaviorTools:",
          "    \"\"\"Story: Generate Behavior Tools - Tests behavior tool generation.\"\"\"",
          "    ",
          "    def test_generator_creates_behavior_tool_for_each_behavior(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Generator creates behavior tool for each behavior",
          "        GIVEN: Bot has multiple behaviors",
          "        WHEN: Generator processes Bot Config",
          "        THEN: Generator creates one tool per behavior",
          "        \"\"\"",
          "        # Given: Bot with behaviors",
          "        bot_config = create_bot_config(workspace_root, 'test_bot', behaviors=['shape', 'discovery'])",
          "        ",
          "        # When: Generate tools",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(bot_name='test_bot', config_path=bot_config, workspace_root=workspace_root)",
          "        tools = generator.generate_behavior_tools()",
          "        ",
          "        # Then: Tools created",
          "        assert len(tools) == 2",
          "        assert any(tool.name == 'test_bot_shape' for tool in tools)",
          "        assert any(tool.name == 'test_bot_discovery' for tool in tools)"
        ]
      },
      "dont": {
        "description": "Wrong file naming, generic/abbreviated class names, abbreviated method names",
        "content": [
          "# DON'T: File name doesn't match sub-epic",
          "# Sub-epic: 'Generate Bot Server And Tools'",
          "# File: test_bot_tools.py  (WRONG - doesn't match sub-epic name)",
          "",
          "# DON'T: One file per story (too many files)",
          "# File: test_generate_bot_tools.py",
          "class TestGenerateBotTools:",
          "    pass",
          "",
          "# File: test_generate_behavior_tools.py",
          "class TestGenerateBehaviorTools:",
          "    pass",
          "",
          "# WRONG: Too many files! Should be one file per sub-epic",
          "",
          "# DON'T: Generic class names not matching story",
          "class TestToolGeneration:  # WRONG - story is 'Generate Bot Tools'",
          "    \"\"\"Generic name - which story is this?\"\"\"",
          "    pass",
          "",
          "# DON'T: Abbreviated class names",
          "class TestGenBotTools:  # WRONG - story is 'Generate Bot Tools'",
          "    pass",
          "",
          "# DON'T: Generic class names",
          "class TestGuardrailsInjection:  # WRONG - story is 'Inject Guardrails as Part of Clarify Requirements'",
          "    pass",
          "",
          "# DON'T: Abbreviated method names",
          "def test_creates_tool(self):  # WRONG - scenario is 'Generator creates bot tool for test_bot'",
          "    pass",
          "",
          "# DON'T: Generic method names",
          "def test_tool_generation(self):  # WRONG - doesn't match scenario name",
          "    pass",
          "",
          "# DON'T: Numbered scenarios",
          "def test_scenario_1(self):  # WRONG - not descriptive, doesn't match scenario",
          "    pass",
          "",
          "# DON'T: Tests over 20 lines (extract to helpers)",
          "def test_generator_creates_bot_tool(self, workspace_root):",
          "    # Given: 10 lines of complex setup...",
          "    # When: 5 lines of action...",
          "    # Then: 10 lines of verification...",
          "    # WRONG: Extract setup to helper function!"
        ]
      }
    },
    {
      "do": {
        "description": "Map story hierarchy to test structure",
        "content": [
          "# Story Hierarchy:",
          "# Epic: Build Agile Bots",
          "#   Sub-epic: Generate Bot Server And Tools",
          "#     Story: Generate Bot Tools",
          "#       Scenario: Generator creates bot tool for test_bot",
          "#       Scenario: Generator creates tool with correct parameters",
          "#     Story: Generate Behavior Tools",
          "#       Scenario: Generator creates behavior tool for each behavior",
          "#   Sub-epic: Invoke Behavior Actions",
          "#     Story: Route Tool Call To Behavior",
          "#     Story: Load Action Instructions",
          "#     Story: Execute Behavior Action",
          "",
          "# Test File Structure:",
          "# test_generate_bot_server_and_tools.py  (matches sub-epic)",
          "#   class TestGenerateBotTools:  (matches story exactly)",
          "#     def test_generator_creates_bot_tool_for_test_bot(...):  (matches scenario exactly)",
          "#     def test_generator_creates_tool_with_correct_parameters(...):  (matches scenario exactly)",
          "#   class TestGenerateBehaviorTools:  (matches story exactly)",
          "#     def test_generator_creates_behavior_tool_for_each_behavior(...):  (matches scenario exactly)",
          "",
          "# test_invoke_behavior_actions.py  (matches sub-epic)",
          "#   class TestRouteToolCallToBehavior:  (matches story exactly)",
          "#   class TestLoadActionInstructions:  (matches story exactly)",
          "#   class TestExecuteBehaviorAction:  (matches story exactly)",
          "",
          "# GOOD: Clear 1-to-1 mapping:",
          "# - Sub-epic → test file",
          "# - Story → test class (EXACT name match)",
          "# - Scenario → test method (EXACT name match)"
        ]
      },
      "dont": {
        "description": "Unclear mapping or inconsistent structure",
        "content": [
          "# BAD: Inconsistent naming",
          "# File: test_bot_tools.py  (doesn't match sub-epic 'Generate Bot Server And Tools')",
          "#   class TestToolGen:  (doesn't match story 'Generate Bot Tools')",
          "#     def test_creates_tool(self):  (doesn't match scenario 'Generator creates bot tool for test_bot')",
          "",
          "# BAD: Multiple stories in wrong order",
          "#   class TestGenerateBehaviorTools:  (should be second)",
          "#   class TestGenerateBotTools:  (should be first)",
          "",
          "# BAD: Mixing sub-epics in same file",
          "# File: test_all_bots.py",
          "#   class TestGenerateBotTools:  (from sub-epic: Generate Bot Server And Tools)",
          "#   class TestInvokeBehaviorActions:  (from sub-epic: Invoke Behavior Actions)",
          "# WRONG: Multiple sub-epics mixed! Should be separate files",
          "",
          "# WRONG: Can't easily map back to story map!"
        ]
      }
    },
    {
      "do": {
        "description": "Convert sub-epic and story names to valid identifiers",
        "content": [
          "# Sub-epic: 'Generate Bot Server And Tools'",
          "# File: test_generate_bot_server_and_tools.py",
          "# - Convert to snake_case",
          "# - Remove special characters",
          "# - Keep words that identify the sub-epic",
          "",
          "# Story: 'Generate MCP Bot Server'",
          "# Class: TestGenerateMCPBotServer",
          "# - Convert to PascalCase",
          "# - Keep words that identify the story",
          "# - Prefix with 'Test'",
          "",
          "# Story: 'Inject Guardrails as Part of Clarify Requirements'",
          "# Class: TestInjectGuardrailsAsPartOfClarifyRequirements",
          "# - Full story name in PascalCase",
          "# - Clear and readable",
          "",
          "# Story: 'Track Activity for Gather Context Action'",
          "# Class: TestTrackActivityForGatherContextAction",
          "# - Includes full context",
          "",
          "# Story: 'Inject Validation Rules for Validate Rules Action'",
          "# Class: TestInjectValidationRulesForValidateRulesAction",
          "# - NOT abbreviated to TestValidationRules"
        ]
      },
      "dont": {
        "description": "Abbreviated or unclear names",
        "content": [
          "# DON'T: Over-abbreviate",
          "# Story: 'Generate MCP Bot Server'",
          "# Class: TestGenMCPSrv  (too abbreviated!)",
          "",
          "# DON'T: Drop important words",
          "# Story: 'Bot Loads Configuration From File'",
          "# Class: TestBotLoadsConfig  (missing 'from file'!)",
          "",
          "# DON'T: Add words not in story",
          "# Story: 'User Creates Story Map'",
          "# Class: TestUserCreatesNewStoryMapDocument  (added 'Document'!)",
          "",
          "# DON'T: Use generic names",
          "# Story: 'Inject Guardrails as Part of Clarify Requirements'",
          "# Class: TestGuardrailsInjection  (generic, missing context!)",
          "",
          "# DON'T: Abbreviate story names",
          "# Story: 'Inject Validation Rules for Validate Rules Action'",
          "# Class: TestInjectRules  (abbreviated!)",
          "",
          "# WRONG: Names should match stories EXACTLY!"
        ]
      }
    },
    {
      "do": {
        "description": "Helper functions keep tests under 20 lines",
        "content": [
          "# Helper function (under 20 lines)",
          "def create_bot_with_behaviors(workspace_root: Path, bot_name: str, behaviors: list) -> tuple[Path, Bot]:",
          "    \"\"\"Helper: Create bot configuration with behaviors and return bot instance.\"\"\"",
          "    config_path = workspace_root / 'bots' / bot_name / 'config.json'",
          "    config_path.parent.mkdir(parents=True, exist_ok=True)",
          "    config = {'name': bot_name, 'behaviors': behaviors}",
          "    config_path.write_text(json.dumps(config))",
          "    ",
          "    from agile_bot.bots.base_bot.src.bot.bot import Bot",
          "    bot = Bot(bot_name=bot_name, workspace_root=workspace_root, config_path=config_path)",
          "    return config_path, bot",
          "",
          "# Test method (under 20 lines)",
          "def test_generator_creates_bot_tool_for_test_bot(self, workspace_root):",
          "    \"\"\"",
          "    SCENARIO: Generator creates bot tool for test_bot",
          "    GIVEN: Bot configuration exists",
          "    WHEN: Generator processes Bot Config",
          "    THEN: Generator creates bot tool instance",
          "    \"\"\"",
          "    # Given: Bot config exists (using helper)",
          "    config_path, bot = create_bot_with_behaviors(workspace_root, 'test_bot', ['shape'])",
          "    ",
          "    # When: Generate tool",
          "    from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "    generator = ToolGenerator(bot_name='test_bot', config_path=config_path, workspace_root=workspace_root)",
          "    tool = generator.generate_bot_tool()",
          "    ",
          "    # Then: Tool created",
          "    assert tool.name == 'test_bot_bot'"
        ]
      },
      "dont": {
        "description": "Long test methods with inline complex setup",
        "content": [
          "# DON'T: Test method over 20 lines",
          "def test_generator_creates_bot_tool(self, workspace_root):",
          "    # Given: Complex setup inline (10+ lines)",
          "    workspace = workspace_root / 'workspace'",
          "    workspace.mkdir()",
          "    bots_dir = workspace / 'bots'",
          "    bots_dir.mkdir()",
          "    bot_dir = bots_dir / 'test_bot'",
          "    bot_dir.mkdir()",
          "    config_dir = bot_dir / 'config'",
          "    config_dir.mkdir()",
          "    config_file = config_dir / 'bot_config.json'",
          "    config = {'name': 'test_bot', 'behaviors': ['shape']}",
          "    config_file.write_text(json.dumps(config))",
          "    # ... more setup ...",
          "    ",
          "    # When: Action (5 lines)",
          "    # ...",
          "    ",
          "    # Then: Verification (10+ lines)",
          "    # ...",
          "    ",
          "    # WRONG: Extract setup to helper function!"
        ]
      }
    },
    {
      "do": {
        "description": "Test classes ordered by story map sequence",
        "content": [
          "# Story Map Order:",
          "# 1. Generate Bot Tools",
          "# 2. Generate Behavior Tools",
          "# 3. Generate MCP Bot Server",
          "",
          "# Test File Order (matches story map):",
          "class TestGenerateBotTools:  # First story",
          "    \"\"\"Story: Generate Bot Tools\"\"\"",
          "    pass",
          "",
          "class TestGenerateBehaviorTools:  # Second story",
          "    \"\"\"Story: Generate Behavior Tools\"\"\"",
          "    pass",
          "",
          "class TestGenerateMCPBotServer:  # Third story",
          "    \"\"\"Story: Generate MCP Bot Server\"\"\"",
          "    pass",
          "",
          "# GOOD: File reads like story map!"
        ]
      },
      "dont": {
        "description": "Test classes out of order",
        "content": [
          "# DON'T: Classes out of story map order",
          "class TestGenerateMCPBotServer:  # Should be third, not first!",
          "    pass",
          "",
          "class TestGenerateBotTools:  # Should be first!",
          "    pass",
          "",
          "class TestGenerateBehaviorTools:  # Should be second!",
          "    pass",
          "",
          "# WRONG: Can't follow story map order!"
        ]
      }
    }
  ],
  "key_principles": [
    "Test file name = sub-epic name in snake_case: test_<sub_epic_name>.py",
    "Test class name = EXACT story name in PascalCase: Test<ExactStoryName>",
    "CRITICAL: Test class MUST match story name EXACTLY (not abbreviated, not generic)",
    "Test method name = EXACT scenario name in snake_case: test_<scenario_name_snake_case>",
    "Test classes appear in same order as stories in story map",
    "One test file per sub-epic (all stories in that sub-epic)",
    "One test class per story (exact 1-to-1 mapping)",
    "One test method per scenario (exact 1-to-1 mapping)",
    "Test methods under 20 lines (extract complex setup to helpers)",
    "Helper functions under 20 lines each",
    "Test classes under 300 lines (split if too large)",
    "Use orchestrator pattern: test methods show flow, helpers handle details",
    "File structure mirrors story map: sub-epic → file, story → class, scenario → method",
    "BAD: TestGuardrailsInjection (generic) vs GOOD: TestInjectGuardrailsAsPartOfClarifyRequirements (exact story name)",
    "BAD: TestValidationRules (generic) vs GOOD: TestInjectValidationRulesForValidateRulesAction (exact story name)"
  ],
  "antipatterns": [
    "Adding increment numbers to filenames (test_increment_3_<name>.py)",
    "One test file per story (too many files)",
    "Mixing multiple sub-epics in one file (poor organization)",
    "Generic class names not matching story names (TestToolGeneration vs TestGenerateBotTools)",
    "Abbreviated class names (TestGenBotTools vs TestGenerateBotTools)",
    "Generic class names (TestGuardrailsInjection vs TestInjectGuardrailsAsPartOfClarifyRequirements)",
    "Abbreviated method names (test_creates_tool vs test_generator_creates_bot_tool_for_test_bot)",
    "Generic method names (test_tool_generation vs test_generator_creates_bot_tool_for_test_bot)",
    "Numbered scenarios (test_scenario_1 vs test_generator_creates_bot_tool_for_test_bot)",
    "Test methods over 20 lines (extract setup to helpers)",
    "Helper functions over 20 lines (split into smaller helpers)",
    "Test classes over 300 lines (split into multiple classes or files)",
    "Test classes out of story map order",
    "Unclear mapping between story map and test structure",
    "CRITICAL MISTAKE: Using generic class names like TestGuardrailsInjection when story is 'Inject Guardrails as Part of Clarify Requirements'",
    "CRITICAL MISTAKE: Using abbreviated class names like TestInjectRules when story is 'Inject Validation Rules for Validate Rules Action'"
  ]
}
