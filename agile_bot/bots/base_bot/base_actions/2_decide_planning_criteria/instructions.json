{
  "actionName": "decide_planning_criteria",
  "instructions": [
    "**CRITICAL WORKFLOW ENFORCEMENT - NO EXCEPTIONS:**",
    "",
    "You MUST go through planning AFTER clarification for EVERY behavior. Do NOT skip planning stage. Do NOT make assumptions about whether planning has been done. The user can explicitly tell you to skip, but you must NEVER skip on your own initiative.",
    "",
    "**MANDATORY WORKFLOW RULE:**",
    "- You MUST go through planning AFTER clarification for EVERY behavior",
    "- Do NOT skip planning stage",
    "- Do NOT make assumptions about whether planning has been done",
    "- The user can explicitly tell you to skip, but you must NEVER skip on your own",
    "- Present ALL decision criteria and assumptions, get user selections before proceeding",
    "",
    "**CRITICAL: Previous Clarification and Planning Data:**",
    "The clarification and planning data from previous stages has been loaded and is shown above. You MUST review and reference this data when presenting assumptions and decision criteria. Previous decisions and assumptions inform the current planning session.",
    "",
    "Present the following assumptions and decision criteria to the user and ask for their opinion on key decisions.",
    "",
    "**Typical Assumptions:**",
    "{{assumptions}}  --> load from `{bot}/behaviors/{behavior}/guardrails/planning/typical_assumptions.json`",
    "",
    "**Decision Making Criteria:**",
    "{{decision_criteria}}  --> load from `{bot}/behaviors/{behavior}/guardrails/planning/decision_criteria/` directory",
    "",
    "Present these assumptions and decision criteria from the data files to the user. Ask them to review the assumptions and select their preferred criteria/options for each decision point.",
    "",
    "**MANDATORY: CONTEXT FILE LOCATIONS:**",
    "- Load clarification data from `{project_area}/docs/stories/clarification.json` (generated file)",
    "- Load original input from `{project_area}/docs/context/input.txt` (original context)",
    "- Save planning decisions to `{project_area}/docs/stories/planning.json` (generated file)",
    "- **Generated files (clarification.json, planning.json) go in `{project_area}/docs/stories/`**",
    "- **Original input files go in `{project_area}/docs/context/`**",
    "",
    "**MANDATORY STORAGE STEP - IMMEDIATE CHECKPOINT:**",
    "",
    "**CRITICAL: Planning data MUST be stored in a SEPARATE file from clarification data.**",
    "",
    "After user confirms decisions, you MUST IMMEDIATELY save planning data using the MCP tool:",
    "",
    "**STEP 1: Prepare planning data structure**",
    "   - **CRITICAL FILE LOCATION: `{project_area}/docs/stories/planning.json`**",
    "   - **NEVER store planning data in `clarification.json` - they are SEPARATE files**",
    "   - **NOT in `{project_area}/docs/context/` - generated files go in `docs/stories/`**",
    "",
    "**STEP 2: Structure the parameters for MCP tool**",
    "   - Call the MCP tool (e.g., `mcp_story-bot_shape` with action `decide_planning_criteria`)",
    "   - **CRITICAL: You MUST wrap all decision criteria in `decisions_made` dict and all assumptions in `assumptions_made` list**",
    "   - Pass parameters with this EXACT structure:",
    "     ```json",
    "     {",
    "       \"decisions_made\": {",
    "           \"decision_key_1\": \"selected_option_1\",",
    "           \"decision_key_2\": [\"option_a\", \"option_b\"],",
    "           \"decision_key_3\": {",
    "             \"nested_key\": \"nested_value\"",
    "           }",
    "       },",
    "       \"assumptions_made\": [",
    "           \"Assumption 1 text\",",
    "           \"Assumption 2 text\"",
    "       ]",
    "     }",
    "     ```",
    "   - **decisions_made**: Dict mapping decision criteria keys (from decision_criteria files) to selected options/values",
    "   - **assumptions_made**: List of assumption strings (load from `typical_assumptions.json` file)",
    "   - **CRITICAL: Parameter keys MUST be `decisions_made` and `assumptions_made` (not individual decision keys)**",
    "   - **WRONG: Do NOT pass individual decision keys at top level like `{'bounded_context_identification': '...', 'flow_scope': '...'}`**",
    "   - **CORRECT: Wrap all decisions in `decisions_made` dict: `{'decisions_made': {'bounded_context_identification': '...', 'flow_scope': '...'}}`**",
    "",
    "**STEP 3: Call MCP tool to save**",
    "   - Invoke the MCP tool with action `decide_planning_criteria`",
    "   - Include `decisions_made` and `assumptions_made` in the parameters",
    "   - The tool will automatically:",
    "     * Create `{project_area}/docs/stories/` directory if needed",
    "     * Load existing planning.json if it exists",
    "     * Merge new behavior section into existing structure",
    "     * Preserve data from other behaviors",
    "     * Save to `{project_area}/docs/stories/planning.json`",
    "",
    "**STEP 4: Verify storage completed**",
    "   - Read back the `planning.json` file to confirm data was saved correctly",
    "   - Verify structure matches expected format",
    "   - Verify behavior section exists with both `decisions_made` and `assumptions_made`",
    "   - Verify other behaviors' data is preserved (if file existed before)",
    "",
    "**CRITICAL RULES:**",
    "   - DO NOT proceed to next action until storage is confirmed complete",
    "   - This is a BLOCKING checkpoint - storage must happen before proceeding",
    "   - Planning data goes in `planning.json`, clarification data goes in `clarification.json` - NEVER mix them",
    "   - Both files go in `{project_area}/docs/stories/` directory",
    "   - **MUST use MCP tool with `decisions_made` and `assumptions_made` parameters - do NOT save file directly**",
    "   - **The tool ONLY saves if parameters contain `decisions_made` or `assumptions_made` keys - individual decision keys will be ignored**",
    "   - **If you pass `{'bounded_context_identification': '...'}` directly, the tool will NOT save - you MUST wrap it in `{'decisions_made': {'bounded_context_identification': '...'}}`**",
    "",
    "**Example MCP tool call:**",
    "   ```python",
    "   mcp_story-bot_shape(",
    "       action='decide_planning_criteria',",
    "       parameters={",
    "           'decisions_made': {",
    "               'bounded_context_identification': 'By business capability - group by what the business does',",
    "               'flow_scope_and_granularity': 'End-to-end user-system behavior',",
    "               'drill_down_approach': ['Focus on highest value areas', 'Dig deep on user workflows'],",
    "               'drill_down_limits': ['Approximate story limit: 5-10 stories'],",
    "               'depth_of_shaping': {",
    "                   'discovery': 'Decompose -> Discover all stories listed',",
    "                   'scenarios': 'Extensive -> Specify all scenarios'",
    "               }",
    "           },",
    "           'assumptions_made': [",
    "               'Focus on user flow over internal systems',",
    "               'Cover the end-to-end scenario'",
    "           ]",
    "       }",
    "   )",
    "   ```",
    "",
    "**Example resulting planning.json structure:**",
    "   ```json",
    "   {",
    "     \"1_shape\": {",
    "       \"decisions_made\": {",
    "         \"bounded_context_identification\": \"By business capability - group by what the business does\",",
    "         \"flow_scope_and_granularity\": \"End-to-end user-system behavior\"",
    "       },",
    "       \"assumptions_made\": [",
    "         \"Focus on user flow over internal systems\",",
    "         \"Cover the end-to-end scenario\"",
    "       ]",
    "     }",
    "   }",
    "   ```",
    "",
    "**MANDATORY: PAUSE FOR HUMAN FEEDBACK**",
    "When this action is complete, AI MUST pause and wait for human feedback. When human says 'done' or confirms completion, you MUST proceed to the next step: **build_knowledge** (call the build_knowledge action tool)."
  ],
  "templates": {
    "assumptions_and_criteria": {
      "template": "Planning Assessment:\n\n**Assumptions I will make:**\n{{assumptions_list}}\n\n**Decision Criteria Available:**\n{{decision_criteria_questions}}\n\n**Options for each criterion:**\n{{criteria_options}}\n\nPlease review the assumptions and select your preferred criteria/options.",
      "description": "Used to present assumptions and decision criteria to user"
    },
    "high_level_assessment": {
      "template": "Based on your selections, here's my approach:\n\n**Selected Criteria:**\n{{selected_criteria}}\n\n**High-Level Assessment:**\n{{high_level_assessment}}\n\n**Reasoning:**\n{{reasoning}}\n\nPlease confirm if this approach is correct, or provide feedback for adjustments.",
      "description": "Used to present high-level assessment after user selects criteria"
    }
  }
}