{
  "actionName": "decide_planning_criteria",
  "instructions": [
    "**CRITICAL WORKFLOW ENFORCEMENT - NO EXCEPTIONS:**",
    "",
    "You MUST go through planning AFTER clarification for EVERY behavior. Do NOT skip planning stage. Do NOT make assumptions about whether planning has been done. The user can explicitly tell you to skip, but you must NEVER skip on your own initiative.",
    "",
    "**MANDATORY WORKFLOW RULE:**",
    "- You MUST go through planning AFTER clarification for EVERY behavior",
    "- Do NOT skip planning stage",
    "- Do NOT make assumptions about whether planning has been done",
    "- The user can explicitly tell you to skip, but you must NEVER skip on your own",
    "- Present ALL decision criteria and assumptions, get user selections before proceeding",
    "",
    "**CRITICAL: Previous Clarification and Planning Data:**",
    "The clarification and planning data from previous stages has been loaded and is shown above. You MUST review and reference this data when presenting assumptions and decision criteria. Previous decisions and assumptions inform the current planning session.",
    "",
    "Present the following assumptions and decision criteria to the user and ask for their opinion on key decisions.",
    "",
    "**Typical Assumptions:**",
    "{{assumptions}}  --> load from `{bot}/behaviors/{behavior}/guardrails/planning/typical_assumptions.json`",
    "",
    "**Decision Making Criteria:**",
    "{{decision_criteria}}  --> load from `{bot}/behaviors/{behavior}/guardrails/planning/decision_criteria/` directory",
    "",
    "Present these assumptions and decision criteria from the data files to the user. Ask them to review the assumptions and select their preferred criteria/options for each decision point.",
    "",
    "**MANDATORY: CONTEXT FILE LOCATIONS:**",
    "- Load clarification data from `{project_area}/docs/stories/clarification.json` (generated file)",
    "- Load original input from `{project_area}/docs/context/input.txt` (original context)",
    "- Save planning decisions to `{project_area}/docs/stories/planning.json` (generated file)",
    "- **Generated files (clarification.json, planning.json) go in `{project_area}/docs/stories/`**",
    "- **Original input files go in `{project_area}/docs/context/`**",
    "",
    "**MANDATORY STORAGE STEP - IMMEDIATE CHECKPOINT:**",
    "",
    "**CRITICAL: Planning data MUST be stored in a SEPARATE file from clarification data.**",
    "",
    "After user confirms decisions, you MUST IMMEDIATELY save planning data by creating/updating the file directly:",
    "",
    "**STEP 1: Prepare file path and directory**",
    "   - **CRITICAL FILE LOCATION: `{project_area}/docs/stories/planning.json`**",
    "   - **NEVER store planning data in `clarification.json` - they are SEPARATE files**",
    "   - **NOT in `{project_area}/docs/context/` - generated files go in `docs/stories/`**",
    "   - Ensure the `{project_area}/docs/stories/` directory exists (create if needed)",
    "",
    "**STEP 2: Load existing planning data (if file exists)**",
    "   - If `planning.json` already exists: Read the file and load existing data",
    "   - If file doesn't exist: Start with empty dict `{}`",
    "   - **CRITICAL: Preserve data from other behaviors if file exists**",
    "",
    "**STEP 3: Create or update planning structure**",
    "   - Use this EXACT structure for the current behavior's section:",
    "     ```json",
    "     {",
    "       \"{behavior_name}\": {",
    "         \"decisions_made\": {",
    "           \"decision_key_1\": \"selected_option_1\",",
    "           \"decision_key_2\": [\"option_a\", \"option_b\"],",
    "           \"decision_key_3\": {",
    "             \"nested_key\": \"nested_value\"",
    "           }",
    "         },",
    "         \"assumptions_made\": [",
    "           \"Assumption 1 text\",",
    "           \"Assumption 2 text\"",
    "         ]",
    "       }",
    "     }",
    "     ```",
    "   - **Behavior name format: Use the behavior identifier exactly as it appears in behavior config (e.g., \"1_shape\", \"2_prioritization\", etc.)**",
    "   - **decisions_made**: Dict mapping decision keys to selected options/values (from user's selections)",
    "   - **assumptions_made**: List of assumption strings (load from `typical_assumptions.json` file)",
    "   - **If file already exists: Merge new behavior section into existing structure, preserve other behaviors' data**",
    "   - **If file doesn't exist: Create new file with only the current behavior's section**",
    "",
    "**STEP 4: Write file**",
    "   - Write the complete planning data structure to `{project_area}/docs/stories/planning.json`",
    "   - Use proper JSON formatting (indented, readable)",
    "",
    "**STEP 5: Verify storage completed**",
    "   - Read back the `planning.json` file to confirm data was saved correctly",
    "   - Verify structure matches expected format",
    "   - Verify behavior section exists with both `decisions_made` and `assumptions_made`",
    "   - Verify other behaviors' data is preserved (if file existed before)",
    "",
    "**CRITICAL RULES:**",
    "   - DO NOT proceed to next action until storage is confirmed complete",
    "   - This is a BLOCKING checkpoint - storage must happen before proceeding",
    "   - Planning data goes in `planning.json`, clarification data goes in `clarification.json` - NEVER mix them",
    "   - Both files go in `{project_area}/docs/stories/` directory",
    "   - You MUST save the file yourself - there is no MCP tool or automatic saving",
    "",
    "**Example structure:**",
    "   ```json",
    "   {",
    "     \"1_shape\": {",
    "       \"decisions_made\": {",
    "         \"drill_down\": \"Dig deep on system interactions\",",
    "         \"flow_scope\": \"End-to-end user-system behavior\"",
    "       },",
    "       \"assumptions_made\": [",
    "         \"Focus on user flow over internal systems\",",
    "         \"Cover the end-to-end scenario\"",
    "       ]",
    "     }",
    "   }",
    "   ```",
    "",
    "**MANDATORY: PAUSE FOR HUMAN FEEDBACK**",
    "When this action is complete, AI MUST pause and wait for human feedback. When human says 'done' or confirms completion, you MUST proceed to the next step: **build_knowledge** (call the build_knowledge action tool)."
  ],
  "templates": {
    "assumptions_and_criteria": {
      "template": "Planning Assessment:\n\n**Assumptions I will make:**\n{{assumptions_list}}\n\n**Decision Criteria Available:**\n{{decision_criteria_questions}}\n\n**Options for each criterion:**\n{{criteria_options}}\n\nPlease review the assumptions and select your preferred criteria/options.",
      "description": "Used to present assumptions and decision criteria to user"
    },
    "high_level_assessment": {
      "template": "Based on your selections, here's my approach:\n\n**Selected Criteria:**\n{{selected_criteria}}\n\n**High-Level Assessment:**\n{{high_level_assessment}}\n\n**Reasoning:**\n{{reasoning}}\n\nPlease confirm if this approach is correct, or provide feedback for adjustments.",
      "description": "Used to present high-level assessment after user selects criteria"
    }
  }
}