{
  "actionName": "render_output",
  "instructions": [
    "**MANDATORY: Before rendering any output, you MUST load and review the project's context files:**",
    "1. Load `{project_area}/docs/stories/clarification.json` - Contains key questions and evidence (generated file)",
    "2. Load `{project_area}/docs/stories/planning.json` - Contains assumptions and decisions (generated file)",
    "3. Load `{project_area}/docs/context/input.txt` (or similar) - Original input/source material (original context)",
    "",
    "**CRITICAL: File locations:**",
    "- **Generated files:** `{project_area}/docs/stories/clarification.json`, `{project_area}/docs/stories/planning.json`",
    "- **Original input:** `{project_area}/docs/context/input.txt` and other original context files",
    "",
    "These files contain critical requirements, decisions, and context that MUST be reflected in all rendered artifacts.",
    "",
    "**CRITICAL: Load planning.json and check for the current behavior's section (e.g., 'shape', 'discovery', 'exploration', 'specification'). Reference decisions_made and assumptions_made for the current behavior, as well as any previous behaviors that affect this work.**",
    "",
    "**MANDATORY STEPS - DO THESE IN ORDER:**",
    "",
    "**STEP 1: Load All Render Configurations**",
    "1. Load and parse ALL `{bot}/behaviors/{behavior}/2_content/2_render/*.json` files (or `{bot}/behaviors/{behavior}/*_content/*_render/*.json` if numbered differently)",
    "2. These files define ALL outputs that must be rendered - do not skip any",
    "3. Each config file specifies: name, type (builder/synchronizer/template), path, input, output, and execution details",
    "",
    "**STEP 2: Execute Builders (Python Scripts)**",
    "For each config file that has a 'builder' OR 'renderer' field (they are the same - both mean execute a Python script):",
    "",
    "1. Identify the builder script:",
    "   - Field name: 'builder' OR 'renderer' (both are equivalent)",
    "   - Value: Python script filename (e.g., 'render_story_map_txt.py')",
    "   - Location: `{bot}/behaviors/{behavior}/2_content/2_render/templates/{builder_script}` or `{bot}/behaviors/{behavior}/*_content/*_render/templates/{builder_script}`",
    "",
    "2. Determine input and output paths:",
    "   - Input: Usually `{project_path}/docs/stories/{input_file}` (check 'input' field in config, default is 'story-graph.json')",
    "   - Output: `{project_path}/{path}/{output}` (from config 'path' and 'output' fields)",
    "",
    "3. Execute the builder script:",
    "   - Command format: `python {builder_script_path} {input_file_path} {output_file_path}`",
    "   - Example: `python agile_bot/bots/story_bot/behaviors/1_shape/2_content/2_render/render_story_map_txt.py demo/mob_minion/docs/stories/story-graph.json demo/mob_minion/docs/stories/story-map.txt`",
    "",
    "4. Verify output file was created at the expected path",
    "",
    "**STEP 3: Execute Synchronizers**",
    "For each config file that has a 'synchronizer' field:",
    "",
    "1. Identify the synchronizer:",
    "   - Field: 'synchronizer' (e.g., 'synchronizers.story_io.DrawIOSynchronizer')",
    "   - Field: 'renderer_command' (e.g., 'render-outline')",
    "   - Field: 'input' (input file, usually 'story-graph.json')",
    "   - Field: 'output' (output file, e.g., 'story-map-outline.drawio')",
    "",
    "2. **Handle Increment Name Substitution in Output Filenames (if needed):**",
    "   - Check if 'output' field contains '{increment_names}' placeholder",
    "   - If placeholder exists:",
    "     a. Load story graph from input file (usually story-graph.json)",
    "     b. Extract increment names from 'increments' array in story graph",
    "     c. If config has 'parameters.increment_names' with specific names, use those",
    "     d. Otherwise, use all increment names from story graph",
    "     e. If no increments found and placeholder exists, use 'all-increments' as fallback",
    "     f. Sanitize increment names for filename:",
    "        - Replace spaces with '-'",
    "        - Remove special characters (keep alphanumeric, '-', '_')",
    "        - Convert to lowercase (optional, for consistency)",
    "        - Limit individual increment name length to 50 chars if needed (to avoid very long filenames)",
    "     g. Join multiple increment names with '-'",
    "     h. If total filename length exceeds 200 chars, consider truncating or using abbreviated names",
    "     i. Replace '{increment_names}' placeholder in output filename",
    "     j. Example: 'story-map-discovery-{increment_names}.drawio' → 'story-map-discovery-Foundation-Create-Mob-and-Basic-Actions.drawio'",
    "     k. For multiple increments: 'story-map-discovery-Foundation-Create-Mob-Strategy-and-Target-Selection.drawio'",
    "   - If no placeholder, use output filename as-is",
    "",
    "3. Execute using story_io CLI tool:",
    "   - Command format: `python -m agile_bot.bots.story_bot.src.synchronizers.story_io.story_io_cli {renderer_command} --story-graph {input_path} --output {output_path}`",
    "   - Use the substituted output filename if placeholder was replaced",
    "   - Example: `python -m agile_bot.bots.story_bot.src.synchronizers.story_io.story_io_cli render-outline --story-graph demo/mob_minion/docs/stories/story-graph.json --output demo/mob_minion/docs/stories/story-map-outline.drawio`",
    "   - Example with increment names: `python -m agile_bot.bots.story_bot.src.synchronizers.story_io.story_io_cli render-discovery --story-graph demo/mob_minion/docs/stories/story-graph.json --output demo/mob_minion/docs/stories/story-map-discovery-Foundation-Create-Mob-and-Basic-Actions.drawio`",
    "   - Note: Use `render-outline`, `render-increments`, `render-discovery`, or `render-exploration` as the command (NOT 'synchronize render-outline')",
    "   - Alternative: Use PowerShell wrapper: `agile_bot/bots/story_bot/src/synchronizers/story_io/cli/story-io.ps1 render-outline -StoryGraph {input_path} -Output {output_path}`",
    "",
    "4. Verify output file was created",
    "",
    "**STEP 4: Render Templates (Direct Template Rendering)**",
    "For each config file that has ONLY a 'template' field (no 'builder', 'renderer', or 'synchronizer' fields):",
    "",
    "1. Load the template file:",
    "   - Location: `{bot}/behaviors/{behavior}/2_content/2_render/templates/{template_file}`",
    "",
    "2. Load input data (usually from `{project_path}/docs/stories/story-graph.json` or `{project_path}/docs/stories/clarification.json`)",
    "",
    "3. Render template with data substitution",
    "",
    "4. Write output to: `{project_path}/{path}/{output}`",
    "",
    "**CRITICAL RULES:**",
    "- Process ALL config files in 2_render/ directory - do not skip any",
    "- 'builder' and 'renderer' fields are EQUIVALENT - both mean execute a Python script",
    "- If a config has both 'builder'/'renderer' AND 'template', use the builder/renderer (script takes precedence)",
    "- Verify each output file exists after execution",
    "- If execution fails, report the error and continue with other outputs",
    "",
    "**Output Instructions:**",
    "{{output_instructions}}  --> load from all {bot}/behaviors/{behavior}/2_content/2_render/{output_name}.json (or {bot}/behaviors/{behavior}/*_content/*_render/{output_name}.json if numbered differently)",
    "",
    "**SYNCHRONIZATION SCRIPTS - MANDATORY (After Rendering):**",
    "After ALL rendering is complete and user confirms ready to proceed:",
    "1. Synchronize configuration is automatically loaded and injected into instructions by render_output action",
    "2. Access synchronize configuration from injected instructions:",
    "   a. synchronize_instructions: General sync instructions from 3_synchronize/instructions.json (if exists)",
    "   b. synchronize_configs: Array of all synchronize_*.json configuration files with loaded templates",
    "3. For each synchronize_config entry:",
    "   - config: The synchronize_*.json configuration (name, description, scripts, templates, instructions)",
    "   - templates: Dictionary of loaded template files (key=template_path, value=template_content)",
    "   - file: Path to the synchronize_*.json file",
    "4. For each synchronize_*.json configuration:",
    "   - Read the 'scripts' array to identify sync scripts to execute",
    "   - Each script entry specifies: name, renderer, renderer_command, description, and parameters",
    "   - Execute sync scripts using the specified renderer (e.g., story_io synchronize command)",
    "   - Use loaded templates from 'templates' dictionary if specified in config 'templates' array",
    "   - Templates are file-based (not code/builders) - use template content directly for formatting/rules",
    "   - Follow the pattern: sync config JSON → project data → sync output",
    "5. Wait for user confirmation that render is complete before running sync scripts",
    "6. Report sync results to user",
    "",
    "**MANDATORY: PAUSE FOR HUMAN FEEDBACK**",
    "When this action is complete, AI MUST pause and wait for human feedback. When human says 'done' or confirms completion, you MUST proceed to the next step: **validate_rules** (call the validate_rules action tool)."
  ]
}
