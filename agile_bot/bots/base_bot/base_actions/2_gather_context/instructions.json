{
  "actionName": "gather_context",
  "instructions": [
    "**CRITICAL WORKFLOW ENFORCEMENT - NO EXCEPTIONS:**",
    "",
    "**When MOVING TO a behavior (switching from a different behavior):** You MUST start at the clarification action (first action). Do NOT skip clarification or planning stages. Do NOT make assumptions about whether clarification/planning has been done. The user can explicitly tell you to skip, but you must NEVER skip on your own initiative.",
    "",
    "**When CONTINUING WITHIN the same behavior:** Use the current action from workflow state. Do NOT restart at clarification unless explicitly switching behaviors.",
    "",
    "**MANDATORY WORKFLOW RULE (applies when moving TO a behavior):**",
    "- When switching to a new behavior, you MUST go through clarification for that behavior",
    "- Do NOT skip clarification stage when moving to a behavior",
    "- Do NOT make assumptions about whether clarification has been done when moving to a behavior",
    "- The user can explicitly tell you to skip, but you must NEVER skip on your own",
    "- Present ALL required questions and wait for answers before proceeding",
    "- **Note:** If continuing within the same behavior, use the current action from workflow state instead",
    "",
    "**MANDATORY CLARIFICATION PROCESS:**",
    "1. Review all provided context (story maps, increments documents, existing files, conversation history, etc.)",
    "2. For EACH required question below, THOUGHTFULLY attempt to answer it yourself using the available context",
    "3. When answering questions:",
    "   - ACTUALLY ANSWER THE QUESTION - don't just list available options without answering",
    "   - If the question asks \"what is the scope\", answer what the scope IS based on context",
    "   - If the question requires a CHOICE/DECISION from the user, identify the available options/deltas and ask the user to choose",
    "   - Be thoughtful and specific in your answers based on what's available in context",
    "4. Place your answers directly with each question in the format:",
    "   **Question:** [question text]",
    "   **Answer:** [your thoughtful answer based on context]",
    "   OR if a choice is needed:",
    "   **Answer:** [your answer based on context]. **Available options:** [list options]. **Which option do you want to choose?**",
    "   OR if information is missing:",
    "   **Answer:** ⚠️ **NOT ENOUGH INFORMATION - REQUIRES USER INPUT**",
    "5. Be EXPLICIT and CLEAR when you cannot answer a question - use \"⚠️ **NOT ENOUGH INFORMATION - REQUIRES USER INPUT**\" so the user knows they must provide this information",
    "6. Do NOT guess or infer answers - if information is not clearly available in context, state that user input is required",
    "7. When a question requires a decision/choice, identify the available deltas/options from context and ask the user to select",
    "8. Present ALL questions with your answers to the user",
    "9. Ask the user to review, confirm, correct, or provide missing answers",
    "10. Do NOT proceed until the user has reviewed and confirmed/corrected all answers",
    "",
    "**MANDATORY: CONTEXT SOURCE LOCATION:**",
    "11. When reviewing context to answer questions, you MUST check these locations IN ORDER:",
    "    1. `{project_area}/docs/context/` folder - Original input files, prompts, source material",
    "    2. `{project_area}/docs/stories/` folder - Generated files (clarification.json, planning.json) if they exist",
    "    3. Conversation history (if available)",
    "    4. Existing project files in `{project_area}/`",
    "    - **PRIMARY SOURCE:** Always start with `{project_area}/docs/context/` folder for original input",
    "    - **Input files:** Read from `{project_area}/docs/context/input.txt` or similar",
    "    - **Prompts:** Read from `{project_area}/docs/context/` folder",
    "    - **Source material:** All original context providers are in `{project_area}/docs/context/`",
    "",
    "**MANDATORY STORAGE STEP - IMMEDIATE CHECKPOINT:**",
    "12. IMMEDIATELY after user confirms all answers are complete and correct, you MUST store clarification data:",
    "    - If MCP tools are available: Call `agent_store_clarification()` MCP tool with:",
    "      * `key_questions_answered`: dict mapping question keys to answer strings",
    "      * `evidence_provided`: dict mapping evidence types to evidence content",
    "    - If MCP tools are NOT available: Create `{project_area}/docs/stories/clarification.json` directly",
    "      * **CRITICAL: Generated file location - `{project_area}/docs/stories/clarification.json`**",
    "      * **NOT in `{project_area}/docs/context/` - generated files go in docs/stories/**",
    "      * Structure: `{\"{behavior}\": {\"key_questions\": {...}, \"evidence\": {...}}}`",
    "      * Ensure the `{project_area}/docs/stories/` directory exists before creating the file",
    "    - DO NOT proceed to next action until storage is confirmed complete",
    "    - This is a BLOCKING checkpoint - storage must happen before proceeding",
    "",
    "Assess the provided context against the required questions and evidence below.",
    "",
    "**Required Key Questions:**",
    "{{key_questions}}   --> load from `{bot}/behaviors/{behavior}/guardrails/required_context/key_questions.json`",
    "",
    "**Required Evidence:**",
    "{{evidence}}  --> load from `{bot}/behaviors/{behavior}/guardrails/required_context/evidence.json`",
    "",
    "For each question, provide a thoughtful answer based on available context. If the question requires a choice/decision, identify available options and ask the user to choose. If the answer cannot be determined from available context, clearly state \"⚠️ **NOT ENOUGH INFORMATION - REQUIRES USER INPUT\".",
    "",
    "**MANDATORY: PAUSE FOR HUMAN FEEDBACK**",
    "When this action is complete, AI MUST pause and wait for human feedback. When human says 'done' or confirms completion, you MUST proceed to the next step: **decide_planning_criteria** (call the decide_planning_criteria action tool)."
  ],
  "templates": {
    "context_sufficient": {
      "template": "Context validation complete. The following key questions were answered:\n{{key_questions_answered}}\n\nThe following evidence was provided:\n{{evidence_provided}}\n\nProceeding to planning stage.",
      "description": "Used when context is sufficient to proceed"
    },
    "context_insufficient": {
      "template": "Context validation indicates missing information. The following key questions still need answers:\n{{missing_key_questions}}\n\nThe following evidence is still required:\n{{missing_evidence}}\n\nPlease provide the missing information to proceed.",
      "description": "Used when context is insufficient and more information is needed"
    }
  }
}