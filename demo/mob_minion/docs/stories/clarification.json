{
  "shape": {
    "key_questions": {
      "user_types": "Game Master (GM) - the primary user who manages minions/tokens in Foundry VTT during RPG sessions",
      "key_goals_behaviors_decisions": "Goal: Efficiently control multiple minions as coordinated groups (mobs) instead of individually. Behavior: Click one minion token to command the entire mob. Decision: Select strategies for mob behavior (attack strongest/weakest, defend leader, attack most damaged, etc.)",
      "primary_users_stakeholders": "Game Masters using Foundry VTT to run RPG sessions with minions",
      "first_action": "Group individual minion tokens into a mob so they can be controlled together",
      "problems_inefficiencies_workarounds": "Eliminates the need to click each minion token individually to perform actions. Currently, GMs must select and command each minion separately, which is time-consuming during combat",
      "struggling_stuck_delays": "During combat/tactical encounters when managing multiple minions, requiring repetitive individual token selection and commands",
      "other_systems_data_sources_tools": "Foundry VTT system - specifically: Actor/token system (to group minions), Combat system (for actions), Movement/range system (for positioning and area attacks), Template system (for spawning mobs from templates)",
      "key_behaviors_integration_points": "Mobs depend on Foundry's actor system to identify and group minions. Mobs use Foundry's combat system to execute actions. Strategies depend on combat state (health, positioning, target selection). Movement/range system determines valid actions and targets. Templates enable spawning mobs from predefined actor configurations",
      "business_domain": "Virtual Tabletop RPG Combat Management - specifically minion/mob coordination within Foundry VTT",
      "core_business_concepts_relationships": "Minion: Individual token/actor that can be grouped. Mob: Collection of minions that act together. Strategy: Behavioral rules for mob actions (attack strongest, attack weakest, defend leader, attack most damaged). Target Selection: Method for choosing which enemy to attack. Action: What the mob does (move, attack, area attack, etc.). Range: Distance constraints for actions. Template: Predefined configuration for spawning mobs",
      "distinct_sub_domains_capabilities": "Mob Management (create, edit, group minions), Strategy Selection (choose mob behavior), Target Selection (determine attack targets), Action Execution (perform mob actions), Template Management (spawn mobs from templates)",
      "boundaries_domain_parts": "Foundry VTT provides the base actor/token/combat systems (out of scope). This system adds mob coordination and strategy layers on top. Boundary: This system coordinates Foundry actors but doesn't replace Foundry's core systems",
      "domain_events": "Mob created, Minions grouped into mob, Strategy selected, Target chosen, Mob action executed (move, attack, area attack), Mob spawned from template",
      "key_business_rules_constraints": "Mobs are collections of minions that act together. Selecting one minion in a mob controls all minions in that mob. Strategies determine target selection and behavior. Actions must respect range/positioning constraints. Mobs can be spawned from templates. Mobs can be edited (add/remove minions)",
      "domain_language": "Mob (collection of minions), Minion (individual token/actor), Strategy (behavioral rules), Target (enemy to attack), Area attack (attack affecting multiple targets), Range (distance constraints), Template (predefined actor configuration), Spawn (create from template), Group (associate minions with mob)"
    },
    "evidence": {
      "user_vision_requirements": "input.txt contains project vision describing mob functionality, strategies, and Foundry VTT integration requirements",
      "existing_system_context": "References to Foundry VTT system and its capabilities (actor/token system, combat system, movement/range system, template system)",
      "user_research": "Input file provides direct user requirements and vision for the system"
    }
  },
  "discovery": {
    "key_questions": {
      "increment_scope": "Increment 1: Foundation - Create Mob and Basic Actions covers: Epic 1: Manage Mobs (Create Mob feature with 4 stories: Select Minion Tokens, Group Minions Into Mob, Assign Mob Name, Designate Mob Leader; Combat Tracker Integration feature with 1 story: Turn Mob On In Combat Tracker). Epic 2: Control Mob Actions (Execute Mob Action feature with 4 stories: Select Action Type, Target Selection, Attack Execution, Respect Range Constraints; Follow Leader Strategy feature with 1 story: Execute Follow Leader Strategy). This increment establishes core mob creation, combat tracker integration, and basic action execution with leader-based strategy.",
      "major_workflows": "Three workflows: 1) Mob Creation Workflow: Select individual minion tokens → Group them into a mob → Assign a name → Designate a mob leader. 2) Combat Tracker Integration: Turn mob on in combat tracker → Mobs appear in combat tracker → Actions execute through combat tracker. 3) Action Execution Workflow (Refined): Select action type → Target selection (determine targets) → Attack execution (execute attacks) → Respect range/positioning constraints.",
      "systems_teams_roles": "User Role: Game Master (GM) - primary user managing minions in Foundry VTT. System Integration: Foundry VTT systems - Actor/Token system (identify and group minions), Combat Tracker system (turn mobs on, track combat state, execute actions), Combat system (execute actions), Movement/Range system (positioning and constraints), Template system (future spawning capability).",
      "story_groupings_capabilities": "Three capabilities: 1) Create Mob Capability (Epic 1, Feature: Create Mob) - Group minions into coordinated mobs with a leader. 2) Combat Tracker Integration Capability (NEW) - Integrate mobs with Foundry's combat tracker. 3) Execute Mob Action Capability (Epic 2, Feature: Execute Mob Action) - Execute coordinated actions with separate targeting and attacking.",
      "story_sequence": "Within Create Mob: Select Minion Tokens (1) → Group Minions Into Mob (2) → Assign Mob Name (3) → Designate Mob Leader (4). Combat Tracker Integration: Turn Mob On In Combat Tracker (can happen after mob creation). Within Execute Mob Action: Select Action Type (1) → Target Selection (2) → Attack Execution (3) → Respect Range Constraints (4). Strategy: Follow Leader Strategy (can be applied during action execution). Between Epics: Create Mob must be completed before Execute Mob Action.",
      "integration_points": "Integration Point 1: Foundry VTT Actor/Token system - selecting and identifying minion tokens. Integration Point 2: Foundry VTT Combat Tracker system - turning mobs on, tracking combat state. Integration Point 3: Foundry VTT Combat system - executing actions through combat tracker. Integration Point 4: Foundry VTT Movement/Range system - validating range constraints and positioning. Transition Point: After mob creation, GM can select any minion in the mob to control the entire mob. Transition Point: Mob leader's actions determine what all other minions do (follow leader strategy).",
      "dependencies": "Execute Mob Action depends on Create Mob - mob must exist before actions can be executed. Combat Tracker Integration depends on Create Mob - mob must exist before it can be turned on in combat tracker. Follow Leader Strategy depends on Mob Leader designation - leader must be designated before strategy can be applied. Attack Execution depends on Target Selection - targets must be determined before attacks can be executed. Within Create Mob, stories are sequential (must select tokens before grouping, must group before naming, must name before designating leader)."
    },
    "evidence": {
      "story_map": "story-graph.json with epics, features, and stories for Increment 1",
      "increments_document": "Increment 1 defined with priority 1 in story-graph.json",
      "domain_model": "mob-minion-domain-model-description.md with domain concepts (Mob, Minion, Strategy, Action, Range, Target)",
      "clarification_shape": "clarification.json with user types, goals, and domain concepts from Shape stage",
      "user_requirements": "User provided clarifications: Foundry VTT combat tracker integration, mob leader functionality, follow leader strategy, separated targeting and attacking stories"
    }
  },
  "tests": {
    "key_questions": {
      "test_framework": "pytest with orchestrator pattern (NO feature files) - matches codebase pattern",
      "test_scope_level": "System level - test full system with external systems mocked out (Foundry VTT is external)",
      "mocking_strategy": "Mock external dependencies - mock Foundry VTT API, integrations, external systems",
      "fixtures_helpers": "Standard pytest fixtures (tmp_path, workspace_root), Foundry VTT API mocks, test data factories for tokens/actors/mobs",
      "test_file_structure": "Match story graph exactly - test files named test_<sub_epic_name>.py (e.g., test_create_mob.py), classes named Test<ExactStoryName>, methods named test_<scenario_name_snake_case>. Location: tests/ directory mirroring story structure",
      "test_data_requirements": "Use scenario data from story documents, create Foundry VTT mock data (tokens, actors, scenes), domain model test fixtures (Mob, Minion objects)",
      "existing_patterns": "Follow pytest orchestrator pattern - test methods show Given-When-Then flow (under 20 lines), helper functions provide reusable operations (under 20 lines), tests verify observable behavior through public API"
    },
    "evidence": {
      "test_framework_pattern": "agile_bot/bots/story_bot/behaviors/7_tests/3_rules/pytest_bdd_orchestrator_pattern.json - pytest with orchestrator pattern, NO feature files",
      "test_naming_rules": "agile_bot/bots/story_bot/behaviors/7_tests/3_rules/tests_must_match_story_graph_exactly.json - test files match sub-epics, classes match stories, methods match scenarios",
      "story_scenarios": "Story documents in docs/stories/map/ with Background and Scenarios sections in Gherkin format",
      "domain_model": "mob-minion-domain-model-description.md with domain concepts (Mob, Minion, Strategy, Action, Range, Target)"
    }
  },
  "code": {
    "key_questions": {
      "programming_language": "Python - tests use pytest, Python syntax",
      "target_file_location": "src/mob_minion/ directory structure (Python package) - Domain: src/mob_minion/domain/ (Mob, Minion entities), Services: src/mob_minion/services/ (MobManager, TokenSelector), Integration: src/mob_minion/integration/ (FoundryVTTClient), Persistence: src/mob_minion/persistence/ (MobRepository)",
      "main_functions_capabilities": "Token selection and highlighting, Foundry VTT API integration (query tokens), Mob grouping, Mob domain object creation, Mob naming and validation, Mob persistence",
      "major_domain_objects": "Mob (collection of minions), Minion (individual token/actor), Strategy (behavioral rules), Action (mob actions), Range (distance constraints), Template (predefined configurations)",
      "programming_paradigm": "Object-oriented programming - tests use classes, domain model uses entities",
      "code_organization": "Domain-Driven Design layers: Domain layer (core entities: Mob, Minion), Service layer (business logic: MobManager, TokenSelector, MobNameValidator), Integration layer (external systems: FoundryVTTClient), Persistence layer (data storage: MobRepository)",
      "key_responsibilities": "TokenSelector: Handle token selection, highlighting, validation. FoundryVTTClient: Query Foundry VTT API for token data. MobManager: Create Mob domain objects from tokens. MobNameValidator: Validate mob names (not empty, unique). MobRepository: Persist/load mob configurations",
      "dependencies": "Foundry VTT API (external, mocked in tests)",
      "code_patterns": "Domain-Driven Design (DDD), Clean Code principles, explicit dependencies, single responsibility",
      "available_inputs": "Story documents with scenarios (docs/stories/map/), Domain model description (mob-minion-domain-model-description.md), Test file (tests/test_create_mob.py), Story graph with acceptance criteria (story-graph.json)",
      "integration_points": "Foundry VTT API (actor/token system, combat system, movement/range system)",
      "error_handling": "Validate token selection (at least one token), Validate mob creation (at least one minion), Handle Foundry VTT API errors (unavailable, invalid data), Validate mob name (not empty, unique), Handle persistence failures",
      "performance_constraints": "None specified - handle reasonable numbers of mobs/minions (typical RPG session: 5-20 mobs, 10-100 minions total)",
      "language_conventions": "PEP 8, type hints, docstrings, explicit dependencies"
    },
    "evidence": {
      "test_file": "tests/test_create_mob.py - shows expected API structure and behavior",
      "domain_model": "mob-minion-domain-model-description.md - defines domain entities and relationships",
      "story_documents": "docs/stories/map/ - story documents with scenarios and acceptance criteria",
      "story_graph": "story-graph.json - structured story map with domain concepts"
    }
  }
}

