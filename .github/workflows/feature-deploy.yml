name: Deploy Features

on:
  push:
    branches: [ main ]
    paths: [ 'features/containerization/**' ]
  workflow_dispatch:

jobs:
  detect-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Detect changed features
      id: detect
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Manual trigger - deploy all features
          FEATURES=$(ls features/containerization/ | grep -v "^_" | grep -v "^containerization$" | tr '\n' ' ')
          echo "features=$FEATURES" >> $GITHUB_OUTPUT
        else
          # Auto-detect changed features
          FEATURES=$(git diff --name-only HEAD~1 HEAD | grep '^features/containerization/[^/]*/' | cut -d'/' -f3 | sort -u | tr '\n' ' ')
          echo "features=$FEATURES" >> $GITHUB_OUTPUT
        fi
    
    - name: Install dependencies
      run: |
        pip install docker requests pyyaml fastapi uvicorn pydantic
    
    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: augmentedteams-hfdzfjhghshucaf6.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Provision and deploy changed features
      env:
        ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      run: |
        for FEATURE in ${{ steps.detect.outputs.features }}; do
          if [ -d "features/containerization/$FEATURE" ]; then
            echo "üì¶ Provisioning and deploying $FEATURE..."
            python features/containerization/$FEATURE/config/provision-service.py AZURE --always
          else
            echo "‚ö†Ô∏è Feature $FEATURE not found in features/containerization/"
          fi
        done
        echo "‚úÖ All features deployed successfully!"
