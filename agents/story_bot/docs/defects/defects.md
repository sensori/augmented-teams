# MCP Agent Defects

> **Active Tracking Document** - Defects are added as they are encountered during development and testing.

---

## 1. Mandatory Action Enforcement
**Error:** `Cannot skip mandatory action 'clarification' without completion`
**Issue:** Workflow didn't indicate completion was required before advancing
**Status:** Fixed - Use `override_mandatory=True` when needed

## 2. File Not Found After Project Area Change
**Error:** `Could not find file 'agents/stories/docs/clarification.json'`
**Issue:** Path resolution didn't update immediately after project area change
**Status:** Fixed - File created on subsequent store calls

## 3. Incorrect File Path Reference
**Error:** `Could not find file 'agents/stories/src/builders.py'`
**Issue:** MCP didn't indicate correct file location (`story_agent.py`)
**Status:** Fixed - Corrected to `agents/stories/src/story_agent.py`

## 4. Project Area Persistence/Caching
**Error:** `agent_get_state` returned old project area after `agent_set_project_area`
**Issue:** `AgentStateManager` cached instance, didn't reset after project area change
**Status:** Fixed - Added `AgentStateManager.reset()` and call in `_set_project_area_impl`

## 5. Automatic Workflow Progression Missing
**Error:** Workflow didn't advance from `build_structure` → `render_output` → `validate`
**Issue:** `_store_structured_impl` and `_store_rendered_impl` didn't call `next_action()`
**Status:** Fixed - Added automatic progression logic to both methods

## 6. Incorrect Output Naming
**Error:** Rendered content stored with key `"shape"` instead of `"story_map"`
**Issue:** `_store_rendered_impl` used behavior name instead of configured output name
**Status:** Fixed - Use `behavior.content.outputs[0].name` for output key

## 7. Workflow Synchronization Missing
**Error:** `agent_get_state` returned inconsistent workflow state
**Issue:** `_get_state_impl` didn't sync project workflow with agent workflow
**Status:** Fixed - Added `_sync_project_workflow` call in `_get_state_impl`

## 8. Acceptance Criteria Written with Code-Level Method Names
**Error:** Acceptance criteria in exploration phase used actual Python method names (e.g., `Agent.__init__()`, `_setup_config_paths()`, `Agent._determine_activity_area()`) instead of plain English descriptions
**Issue:** Acceptance criteria were unreadable and too low-level, using code implementation details instead of business/user language. Should use higher-level concepts and plain English while still being specific about component interactions
**Status:** Fixed - Rewrote all acceptance criteria to use plain English descriptions (e.g., "When Agent initializes" instead of "When Agent.__init__() is called")

## 9. Unnecessary MCP Store Calls After Direct File Updates
**Error:** AI calls MCP store tools (e.g., `agent_store_structured`) after directly updating files using file editing tools (e.g., `search_replace`, `write`)
**Issue:** When AI directly updates files using file editing tools, the files are already saved locally. MCP store tools are meant for when content is generated by AI and needs to be stored through the agent's workflow, not when files are directly edited. Calling store after direct edits is redundant and can cause confusion.
**Status:** Open - AI should not call MCP store tools after directly editing files

## 10. Scenario Backgrounds Should Be in Steps Section
**Error:** Scenario-specific background steps were placed in separate Background sections instead of being included in the Steps section as Given steps
**Issue:** In Gherkin specification format, all Given steps (both common and scenario-specific) should be in the Steps section, not in separate Background sections. The Background section at story level is for documentation only - actual Given steps belong in each scenario's Steps section starting with "Given".
**Status:** Fixed - Moved all background steps into Steps sections as Given steps

Did not run arrange behvor before exploraitron  (its after prioritization)

we need to warn when skip a step and get confirmation

rendered documents not saving
rendered documents not alled automatically after builkd structure
missing rendered documents in shaping
arrange didnt work first time

## 11. Specification Creation Defects - Initialize Behavior and Workflow Story

1. **Missing data in initial specification**: When asked to add data to outcomes, the initial specification was created without proper data tables containing exact values for both input and output variables.

2. **Data not added to outcomes when requested**: When explicitly asked to add data to outcomes, the data was not actually added to the Examples tables - the request was acknowledged but not implemented.

3. **Incorrect background structure**: Backgrounds were placed in front of every scenario instead of having a common background section at the story level, with only scenario-specific Givens in the first step of each scenario for non-common setup.

4. **Repetitive backgrounds**: Common setup steps were repeated in each scenario's Background section instead of being consolidated into a single common Background section.

5. **Missing Givens in scenarios**: Scenarios did not have Givens in the first step for non-common setup - all setup was incorrectly placed in Background sections.

6. **Incomplete data tables**: Data tables did not have exact values for all variables, especially outcome/expected result variables.

## 12. Source Material Section Incorrect Format

**Issue**: Source Material sections in story files use generic placeholder text "Inherited From: Story Map" with a note to "See story map Source Material section for primary source" instead of actually listing the source materials.

**Problem**: The Source Material section should reference:
- The story map document
- The structured JSON files
- The exploration documents

**Current format (incorrect)**:
```
## Source Material

**Inherited From**: Story Map
- See story map "Source Material" section for primary source
- Additional source references will be added during Exploration phase
```

**Expected format**: Should list actual source documents with paths and references to structured JSON and exploration documents.
